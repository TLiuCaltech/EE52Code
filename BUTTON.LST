8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE BUTTON
OBJECT MODULE PLACED IN BUTTON.OBJ
ASSEMBLER INVOKED BY:  C:\WINDOWS\SYSTEM32\ASM86.EXE BUTTON.ASM M1 EP DB


LOC  OBJ                  LINE     SOURCE

                             1         NAME    BUTTON
                             2     
                             3     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             4     ;                                                                            ;
                             5     ;                                    Button                                  ;
                             6     ;                               Button Functions                             ;
                             7     ;                                   EE/CS 51                                 ;
                             8     ;                                                                            ;
                             9     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                            10     
                            11     ; Description:    Functions for scanning the keys.
                            12     ;
                            13     ; Revision History:
                            14     ;        2/3/16    Tim Liu    created file
                            15     ;        2/4/16    Tim Liu    finished writing outline
                            16     ;        4/4/16    Tim Liu    changed button to buttons
                            17     ;        4/21/16   Tim Liu    wrote stub function for ButtonDebounce
                            18     ;        4/21/16   Tim Liu    wrote InitButtons
                            19     ;        4/21/16   Tim Liu    wrote ButtonDebounce
                            20     ;        4/24/16   Tim Liu    added enqueue call to ButtonDebounce
                            21     ;        4/24/16   Tim Liu    wrote Key_available
                            22     ;        4/24/16   Tim Liu    wrote GetKey
                            23     ;
                            24     ;
                            25     ; Table of Contents
                            26     ;
                            27     ;        InitButtons - initializes the functions needed for buttons
                            28     ;        ButtonDebounce - scans a the key address and debounces
                            29     ;        key_available - returns TRUE if there is a valid key
                            30     ;        getkey - returns the key code for the debounced key
                            31     ;        KeyCodeTable - maps button bit pattern to getkey keycodes  
                            32     
                            33     ; local include files
                            34     
                            35 +1  $INCLUDE(BUTTON.INC)
                      =1    36     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    37     ;                                                                            ;
                      =1    38     ;                                   Button.inc                               ;
                      =1    39     ;                              Button Include File                           ;
                      =1    40     ;                                   EE/CS 52                                 ;
                      =1    41     ;                                                                            ;
                      =1    42     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    43     
                      =1    44     ; This file contains the definitions for button.asm
                      =1    45     ;
                      =1    46     ; Revision History:
                      =1    47     ;    4/21/16     Timothy Liu     created file - initial revision
                      =1    48     ;    4/26/16     Timothy Liu     added KeyCodeOffset
                      =1    49     
  0032                =1    50     DebounceTime         EQU        50      ;miliseconds to debounce the keypad
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    2


LOC  OBJ                  LINE     SOURCE

  012C                =1    51     RepeatRate           EQU        300     ;miliseconds between auto-repeat
                      =1    52     
  00FF                =1    53     NoButtonPressed      EQU   0FFh         ;indicates no button pressed
                      =1    54     
  0000                =1    55     ButtonAddress        EQU   0            ;starting address of buttons
                      =1    56     
  00BF                =1    57     KeyCodeOffset        EQU   191          ;value subtracted from button bit
                      =1    58                                             ;pattern to index into KeyCodeTable
                      =1    59     
  0006                =1    60     MaxKeyCode           EQU    6           ;largest valid key code
                            61 +1  $INCLUDE(QUEUE.INC)
                      =1    62     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    63     ;                                                                            ;
                      =1    64     ;                                   QUEUE                                    ;
                      =1    65     ;                             Conversion Functions                           ;
                      =1    66     ;                                   EE/CS 51                                 ;
                      =1    67     ;                                                                            ;
                      =1    68     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    69     
                      =1    70     
                      =1    71     ; This file contains the definitions for the queue structure and several
                      =1    72     ; constants.
                      =1    73     ;
                      =1    74     ; Revision History:
                      =1    75     ;   10/20/15    Tim Liu   Wrote struct definition
                      =1    76     ;   10/21/15    Tim Liu   Changed names to avoid protected names
                      =1    77     ;   10/22/15    Tim Liu   Updated comments
                      =1    78     ;   4/21/16     Tim Liu   Changed array_size to 256 bytes
                      =1    79     
                      =1    80     ;Queue definitions
                      =1    81     
  0100                =1    82     array_size         EQU     256    ;number of bytes in a queue
  00FF                =1    83     ModByteMask        EQU     255    ;number to AND with to get mod 1024
  007F                =1    84     ModWordMask        EQU     127     ;number to AND with to get mod 512
                      =1    85     
  0001                =1    86     WordQueueType      EQU        1    ;make a word queue
  0000                =1    87     ByteQueueType      EQU        0    ;make a byte queue
                      =1    88     
                      =1    89     ; Structure for queue
                      =1    90     
----                  =1    91     QueueStruct    STRUC
0000                  =1    92         word_byte  DB                 ?     ;size of each element
0001                  =1    93         filled     DW                 ?     ;number of elements filled
0003                  =1    94         head       DW                 ?     ;value of head index
0005                  =1    95         tail       DW                 ?     ;value of tail index
0007                  =1    96         content    DB array_size DUP (?)    ;array for storing contents
----                  =1    97     QueueStruct    ENDS
                            98 +1  $INCLUDE(GENERAL.INC)
                      =1    99     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1   100     ;                                                                            ;
                      =1   101     ;                                  General.INC                               ;
                      =1   102     ;                               General include file                         ;
                      =1   103     ;                                   EE/CS 51                                 ;
                      =1   104     ;                                                                            ;
                      =1   105     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    3


LOC  OBJ                  LINE     SOURCE

                      =1   106     
                      =1   107     ; This file contains general definitions and constants.
                      =1   108     ;
                      =1   109     ; Revision History:
                      =1   110     ;    11/3/15     Timothy Liu     initial revision
                      =1   111     ;    11/5/15     Timothy Liu     fixed formatting
                      =1   112     ;    11/5/15     Timothy Liu     update for HW6 - added timer1vec
                      =1   113     ;    11/17/15    Timothy Liu     update for HW7 - added Serial_Vector and INT2EOI
                      =1   114     ;    11/19/15    Timothy Liu     removed interrupt related definitions
                      =1   115     ;    12/5/15     Timothy Liu     added ASCII definitions
                      =1   116     
                      =1   117     
                      =1   118     
  0004                =1   119     BitsPerNibble        EQU        4         ;number of bits in a nibble
                      =1   120     
  0002                =1   121     OffSize              EQU        2         ;offset size in bytes
                      =1   122     
                      =1   123     ;Ascii definitions
  000D                =1   124     ASCII_CR             EQU       13         ;ASCII carriage return
  0044                =1   125     ASCII_D              EQU       68         ;ASCII code for D
  0045                =1   126     ASCII_E              EQU       69         ;ASCII E
  0046                =1   127     ASCII_F              EQU       70         ;F character for fire (laser on)
  0049                =1   128     ASCII_I              EQU       73         ;I character
  004C                =1   129     ASCII_L              EQU       76         ;L character
  004F                =1   130     ASCII_O              EQU       79         ;O character for off (laser off)
  0050                =1   131     ASCII_P              EQU       80         ;P character
  0052                =1   132     ASCII_R              EQU       82         ;R character
  0053                =1   133     ASCII_S              EQU       83         ;S character
  0054                =1   134     ASCII_T              EQU       84         ;T character
  0000                =1   135     ASCII_NULL           EQU        0         ;ASCII null character
  0020                =1   136     ASCII_SPACE          EQU       32         ;ASCII space
  003A                =1   137     ASCII_COLON          EQU       58         ;ASCII colon
  003E                =1   138     ASCII_RArrow         EQU       62         ;ASCII > symbol
                      =1   139     
  0001                =1   140     TRUE                 EQU        1         ;true
  0000                =1   141     FALSE                EQU        0         ;false
                      =1   142     
  0002                =1   143     WORD_SIZE            EQU        2         ;2 bytes per word
  0002                =1   144     FAR_SIZE             EQU        2         ;2 words per far address
  1000                =1   145     Segment_Overlap      EQU    1000H         ;number of unique ways to map physical
                      =1   146                                               ;address
                           147     
                           148     
                           149     CGROUP    GROUP    CODE
                           150     DGROUP    GROUP    DATA
                           151     
----                       152     CODE SEGMENT PUBLIC 'CODE'
                           153     
                           154             ASSUME  CS:CGROUP, DS:DGROUP
                           155     
                           156     ;external function declarations
                           157     
                           158         EXTRN    QueueInit:NEAR                 ;initializes a queue
                           159         EXTRN    QueueFull:NEAR                 ;check if queue is full
                           160         EXTRN    Enqueue:NEAR                   ;add event to queue
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           161         EXTRN    QueueEmpty:NEAR                ;check if the queue is empty
                           162         EXTRN    Dequeue:NEAR                   ;remove element from queue
                           163     
                           164     ;Name:               InitButtons
                           165     ;
                           166     ;Description:        This function initializes the shared variables for the
                           167     ;                    button functions. The function sets the value of
                           168     ;                    DebounceCnt to zero and sets LastRead to NoKeyPressed.
                           169     ;
                           170     ;Operation:          The function sets each of the three shared variables
                           171     ;                    to the listed values. DebounceCnt is set to zero and
                           172     ;                    LastRead is set to NobuttonPressed.
                           173     ;
                           174     ;Arguments:          None
                           175     ;
                           176     ;Return Values:      None
                           177     ;
                           178     ;Local Variables:    None
                           179     ;
                           180     ;Shared Variables:   KeyCode (W) - code for the key being pressed
                           181     ;                    LastRead
                           182     ;
                           183     ;Input:              None
                           184     ;
                           185     ;Output:             None
                           186     ;
                           187     ;Error Handling:     None
                           188     ;
                           189     ;Algorithms:         None
                           190     ;
                           191     ;Registers Used:     None
                           192     ;
                           193     ;Known Bugs:         None
                           194     ;
                           195     ;Limitations:        None
                           196     ;
                           197     ;Last Modified:      2/4/16
                           198     
                           199     ;Outline
                           200     ;InitButtons()
                           201     ;    DebounceCnt = 0                     ;clear the debounce timer
                           202     ;    LastRead = NoButtonPressed          ;indicate no key is pressed
                           203     ;    RETURN
                           204     
                           205     
                           206     
0000                       207     InitButtons    PROC    NEAR
                           208                    PUBLIC  InitButtons
                           209     
0000                       210     InitButtonsStart:
0000 C70600003200   R      211         MOV    DebounceCnt, DebounceTime     ;load the debounce counter
0006 C6060200FF90   R      212         MOV    LastRead, NoButtonPressed     ;nothing pressed yet
                           213     
000C                       214     InitButtonsQueue:                        ;label for initializing queue
000C 56                    215         PUSH   SI                            ;save registers
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    5


LOC  OBJ                  LINE     SOURCE

000D 53                    216         PUSH   BX
                           217     
000E                       218     InitButtonsQueueArgs:                    ;set up arguments for QueueInit
000E 8D360300       R      219         LEA    SI, ButtonQueue               ;load address of the queue
0012 B300                  220         MOV    BL, ByteQueueType             ;make ButtonQueue a byte queue
0014 E80000         E      221         CALL   QueueInit                     ;initialize queue
                           222     
0017                       223     InitButtonsEnd:                          ;finished - restore registers
0017 5B                    224         POP    BX
0018 5E                    225         POP    SI
                           226     
0019 C3                    227         RET
                           228     
                           229     InitButtons ENDP
                           230     
                           231     
                           232     
                           233     ;Name:               ButtonDebounce()
                           234     ;
                           235     ;Description:        This function reads the address of the buttons to
                           236     ;                    see if a button is pressed. If a button is pressed,
                           237     ;                    the function debounces the press and enqueues the button
                           238     ;                    code to the buttonQueue using the function EnqueueEvent.
                           239     ;                    This function also implements auto repeat. If the 
                           240     ;                    same button is held down, then the button press will
                           241     ;                    be recorded every RepeatRate milliseconds. Only one
                           242     ;                    button can be pushed at a time. If multiple buttons
                           243     ;                    are pressed, the function will act like no
                           244     ;                    buttons are being pressed. This function is called by
                           245     ;                    the interrupt handler buttonHandler every millisecond.
                           246     ;
                           247     ;Operation:          When called, the function reads in from the address
                           248     ;                    buttonAddress. If the value of the input is equal to
                           249     ;                    NoButtonPressed or if the value of the input is not
                           250     ;                    equal to LastRead, then the function resets the debounce
                           251     ;                    counter. If the value of the input is different from
                           252     ;                    the last input, then LastRead is updated. If the input
                           253     ;                    is the same as LastRead, then the function decrements
                           254     ;                    DebounceCnt. Once DebounceCnt reaches zero, the function
                           255     ;                    calls EnqueueEvent and enqueues the key press to the
                           256     ;                    buttonQueue.
                           257     ;
                           258     ;Arguments:          None
                           259     ;
                           260     ;Return Values:      None
                           261     ;
                           262     ;Local Variables:    KeyInput (AL) - input from the key being pressed.
                           263     ;
                           264     ;Shared Variables:   DebounceCnt (R/W) - how many additional interrupts
                           265     ;                    must occur before the button press is debounced
                           266     ;                    LastRead (R/W) - the value of the last key that was
                           267     ;                    pressed.
                           268     ;
                           269     ;Input:              8 possible button presses from 8 different buttons
                           270     ;
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           271     ;Output:             None
                           272     ;
                           273     ;Error Handling:     None
                           274     ;
                           275     ;Algorithms:         None
                           276     ;
                           277     ;Registers Changed:  Flag registers
                           278     ;
                           279     ;Known Bugs:         None
                           280     ;
                           281     ;Limitations:        None
                           282     ;
                           283     ;Last Modified:      4/24/16
                           284     ;
                           285     ;Outline
                           286     ;
                           287     ;buttonDebounce()
                           288     
                           289     ;Input(ReadAddress, buttonInput)          ;read a word from the port
                           290     ;
                           291     ;IF (ButtonInput == NoKeyPressed) OR      ;check if button was pressed
                           292     ;    (ButtonInput != LastRead):           ;check if button is same
                           293     ;    DebounceCnt = DebounceTime           ;reset the debounce counter
                           294     ;    LastRead = KeyInput                  ;update which button was pressed
                           295     ;
                           296     ;ELSE:                                    ;if a button was pressed
                           297     ;    DebounceCnt --                       ;debounce the button
                           298     ;    IF DebounceCnt == 0:                 ;button is debounced
                           299     ;        CALL EnQueue                     ;enqueue the button press event
                           300     ;        DebounceCnt = RepeatRate         ;implement auto-repeat
                           301     ;
                           302     ;RETURN
                           303     
                           304     
001A                       305     ButtonDebounce        PROC    NEAR
                           306                           PUBLIC  ButtonDebounce
                           307     
                           308     
001A                       309     ButtonDebounceStart:
001A 50                    310         PUSH  AX                               ;save registers
001B 56                    311         PUSH  SI
                           312     
001C                       313     ButtonDebounceRead:
001C 32E4                  314         XOR    AH, AH                          ;clear high byte
001E E400                  315         IN     AL, ButtonAddress               ;read the button byte
                           316     
0020                       317     CheckButtonPressed:
0020 3CFF                  318         CMP    AL, NoButtonPressed             ;check if no button is pressed
0022 7409                  319         JE     ResetPress                      ;if no key pressed, go to label
                           320     
0024 3A060200       R      321         CMP    AL, LastRead                    ;check if button is same as last
0028 7503                  322         JNE    ResetPress                      ;reset if different button
002A EB1490                323         JMP    HaveButton                      ;otherwise take care of button
                           324     
002D                       325     ResetPress:
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    7


LOC  OBJ                  LINE     SOURCE

002D C70600003200   R      326         MOV    DebounceCnt, DebounceTime       ;reset the debounce counter
0033 3CFF                  327         CMP    AL, NoButtonPressed             ;if a different key is pressed
0035 7503                  328         JNE    UpdateLastPressed               ;then update the last pressed
0037 EB3F90                329         JMP    ButtonDebounceEnd               ;finish the function
                           330     
003A                       331     UpdateLastpressed:
003A A20200         R      332         MOV    LastRead, AL                    ;update last read key
003D EB3990                333         JMP    ButtonDebounceEnd               ;end
                           334     
0040                       335     HaveButton:
0040 FF0E0000       R      336         DEC    DebounceCnt                      ;one fewer cycle to wait
0044 833E000000     R      337         CMP    DebounceCnt, 0                   ;check if debounce is over
0049 7403                  338         JE     ConButton2Code                   ;convert bit pattern to key code
004B EB2B90                339         JMP    ButtonDebounceEnd                ;otherwise end the function
                           340     
004E                       341     ConButton2Code:                            ;convert bit pattern to key code
004E 2DBF00                342         SUB    AX, KeyCodeOffset               ;bit pattern to table offset
0051 8BD8                  343         MOV    BX, AX                          ;copy table offset to indexing register
0053 2E8A87A400     R      344         MOV    AL, CS:KeyCodeTable[BX]         ;look up key code
0058 3D0600                345         CMP    AX, MaxKeyCode                  ;check if key code is valid
005B 771B                  346         JA     ButtonDebounceEnd               ;invalid key code
005D EB0190                347         JMP    SendButtonPress                 ;otherwise send the press
                           348     
0060                       349     SendButtonPress:
                           350             
0060 8D360300       R      351         LEA    SI, ButtonQueue                  ;load address - arg for queue funds
0064 E80000         E      352         CALL   QueueFull                        ;Check if the queue is full
0067 740C                  353         JZ     ButtonDebounceQFull              ;full - jump to emergency label
                           354     
0069 E80000         E      355         CALL   EnQueue                          ;if not full, enqueue key pattern
006C C70600002C01   R      356         MOV    DebounceCnt, RepeatRate          ;set up auto repeat
0072 EB0490                357         JMP    ButtonDebounceEnd                ;go to function end
                           358     
0075                       359     ButtonDebounceQFull:
0075 EB0190                360         JMP   ButtonDebounceEnd                 ;nothing for now - later set
                           361                                                 ;an abort flag
                           362     
0078                       363     ButtonDebounceEnd:
0078 5E                    364         POP    SI                               ;restore registers
0079 58                    365         POP    AX
007A C3                    366         RET                                     ;end of function - return
                           367     
                           368     ButtonDebounce ENDP
                           369     
                           370     
                           371     
                           372     
                           373     ;Name:               Key_Available
                           374     ;
                           375     ;Description:        This function checks if there is a button press ready
                           376     ;                    for processing. The function calls QueueEmpty to check
                           377     ;                    if the buttonQueue is empty. If buttonQueue is empty,
                           378     ;                    then the function returns TRUE and if there is no
                           379     ;                    button press ready the function returns FALSE.
                           380     ;
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    8


LOC  OBJ                  LINE     SOURCE

                           381     ;Operation:          Call QueueEmpty to check if the buttonQueue has any
                           382     ;                    elements in it. If QueueEmpty returns with the 
                           383     ;                    buttonQueue empty, the function returns with FALSE in
                           384     ;                    AX. Otherwise, the function returns TRUE in AX.
                           385     ;
                           386     ;Arguments:          None
                           387     ;
                           388     ;Return Values:      Havebutton (AX) - TRUE if a button is ready to be
                           389     ;                    processed; FALSE if no button press
                           390     ;
                           391     ;Local Variables:    QueueAddress (SI) - address of queue. Argument to
                           392     ;                    QueueEmpty
                           393     ;
                           394     ;Shared Variables:   None
                           395     ;
                           396     ;Output:             None
                           397     ;
                           398     ;Error Handling:     None
                           399     ;
                           400     ;Algorithms:         None
                           401     ;
                           402     ;Registers Used:     AX
                           403     ;
                           404     ;Known Bugs:         None
                           405     ;
                           406     ;Limitations:        None
                           407     ;
                           408     ;Last Modified:      4/24/16
                           409     
                           410     ;Outline
                           411     ;Key_Available():
                           412     ;    QueueAddress = Address(buttonQueue)        ;load the argument
                           413     ;    IF QueueEmpty(QueueAddress) == TRUE:       ;call function to check if
                           414     ;                                               ;button queue is empty
                           415     ;        HaveButton == FALSE                    ;no button available
                           416     ;    ELSE:                                      ;otherwise, thereb^^s a button
                           417     ;        HaveButton == TRUE                     ;indicate a button is ready
                           418     ;    RETURN
                           419     
007B                       420     Key_Available    PROC    NEAR
                           421                      PUBLIC  Key_Available
                           422     
007B                       423     Key_AvailableStart:
007B 56                    424         PUSH    SI                                  ;save register
                           425     
007C                       426     Key_AvailableCheck:                             ;check if queue is empty
007C 8D360300       R      427         LEA     SI, ButtonQueue                     ;load QueueEmpty argument
0080 E80000         E      428         CALL    QueueEmpty                          ;check if queue is empty
0083 7409                  429         JZ      Key_AvailableNo                     ;Queue empty - no key
0085 EB0190                430         JMP     Key_AvailableYes                    ;otherwise there is key
                           431         
                           432     
0088                       433     Key_AvailableYes:                               ;label if key is available
0088 B80100                434         MOV    AX, TRUE                             ;load return value
008B EB0790                435         JMP    Key_AvailableDone                    ;finish function
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE    9


LOC  OBJ                  LINE     SOURCE

                           436     
008E                       437     Key_AvailableNo:                                ;label if no key available
008E B80000                438         MOV    AX, FALSE                            ;load return value
0091 EB0190                439         JMP    Key_AvailableDone                    ;finish function
                           440     
0094                       441     Key_AvailableDone:                              ;end of function
0094 5E                    442         POP     SI                                  ;restore register
0095 C3                    443         RET
                           444     
                           445     Key_Available    ENDP
                           446     
                           447     
                           448     ;Name:               getkey
                           449     ;
                           450     ;Description:        This function returns the key code for a debounced
                           451     ;                    key. The function does not return until it has
                           452     ;                    a valid key.                    
                           453     ;
                           454     ;Operation:          Load the starting address of the button queue to
                           455     ;                    register SI. Clear out AX. Then, call Dequeue
                           456     ;                    to remove a button event from the button queue.
                           457     ;                    Return with the button key code.
                           458     ;
                           459     ;Arguments:          None
                           460     ;
                           461     ;Return Values:      KeyCode (AX) - key code corresponding to one of the
                           462     ;                    key presses.
                           463     ;
                           464     ;Local Variables:    QueueAddress (SI) - address of queue. Argument to
                           465     ;                    QueueEmpty
                           466     ;
                           467     ;Shared Variables:   None
                           468     ;
                           469     ;Output:             None
                           470     ;
                           471     ;Error Handling:     None
                           472     ;
                           473     ;Algorithms:         None
                           474     ;
                           475     ;Registers Used:     AX
                           476     ;
                           477     ;Known Bugs:         None
                           478     ;
                           479     ;Limitations:        None
                           480     ;
                           481     ;Last Modified:      4/24/16
                           482     
                           483     ;Outline
                           484     
0096                       485     GetKey        PROC    NEAR
                           486                   PUBLIC  GetKey
                           487     
0096                       488     GetKeyStart:                               ;starting label
0096 56                    489         PUSH    SI                             ;save the registers
0097 53                    490         PUSH    BX                             
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE   10


LOC  OBJ                  LINE     SOURCE

0098 33C0                  491         XOR     AX, AX                         ;clear out return register
                           492     
009A                       493     GetKeyDequeue:
009A 8D360300       R      494         LEA    SI, ButtonQueue                 ;argument for Dequeue
009E E80000         E      495         CALL   DeQueue                         ;remove button press from queue
                           496     
00A1                       497     GetKeyDone:                                ;end of function
00A1 5B                    498         POP    BX                              ;restore registers
00A2 5E                    499         POP    SI
00A3 C3                    500         RET
                           501     
                           502     GetKey    ENDP
                           503     
                           504     ; Name:  KeyCodeTable
                           505     ;
                           506     ; Description:   This table maps the bit patterns read in from the keys to
                           507     ;                the key codes that will be returned by get_key. The lowest
                           508     ;                bit pattern read in from the keys is 191 in base 10. 191
                           509     ;                is subtracted from the bit patterns, and the result is used
                           510     ;                to index into the table.
                           511     ; Author:        Timothy Liu
                           512     ; Last Modified  4/26/16
                           513     
00A4                       514     KeyCodeTable        LABEL    BYTE
                           515                         PUBLIC   KeyCodeTable
                           516     
                           517     ;        DB        KeyCode
00A4 00                    518              DB        0        ;SW3 - 0
00A5 07                    519              DB        7        ;Invalid key - 1     
00A6 07                    520              DB        7        ;Invalid key - 2     
00A7 07                    521              DB        7        ;Invalid key - 3     
00A8 07                    522              DB        7        ;Invalid key - 4     
00A9 07                    523              DB        7        ;Invalid key - 5     
00AA 07                    524              DB        7        ;Invalid key - 6     
00AB 07                    525              DB        7        ;Invalid key - 7     
00AC 07                    526              DB        7        ;Invalid key - 8     
00AD 07                    527              DB        7        ;Invalid key - 9     
00AE 07                    528              DB        7        ;Invalid key - 10     
00AF 07                    529              DB        7        ;Invalid key - 11     
00B0 07                    530              DB        7        ;Invalid key - 12     
00B1 07                    531              DB        7        ;Invalid key - 13     
00B2 07                    532              DB        7        ;Invalid key - 14     
00B3 07                    533              DB        7        ;Invalid key - 15     
00B4 07                    534              DB        7        ;Invalid key - 16     
00B5 07                    535              DB        7        ;Invalid key - 17     
00B6 07                    536              DB        7        ;Invalid key - 18     
00B7 07                    537              DB        7        ;Invalid key - 19     
00B8 07                    538              DB        7        ;Invalid key - 20     
00B9 07                    539              DB        7        ;Invalid key - 21    
00BA 07                    540              DB        7        ;Invalid key - 22    
00BB 07                    541              DB        7        ;Invalid key - 23    
00BC 07                    542              DB        7        ;Invalid key - 24    
00BD 07                    543              DB        7        ;Invalid key - 25    
00BE 07                    544              DB        7        ;Invalid key - 26    
00BF 07                    545              DB        7        ;Invalid key - 27    
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE   11


LOC  OBJ                  LINE     SOURCE

00C0 07                    546              DB        7        ;Invalid key - 28    
00C1 07                    547              DB        7        ;Invalid key - 29    
00C2 07                    548              DB        7        ;Invalid key - 30    
00C3 07                    549              DB        7        ;Invalid key - 31    
00C4 01                    550              DB        1        ;SW4 - 32    
00C5 07                    551              DB        7        ;Invalid key - 33    
00C6 07                    552              DB        7        ;Invalid key - 34    
00C7 07                    553              DB        7        ;Invalid key - 35    
00C8 07                    554              DB        7        ;Invalid key - 36    
00C9 07                    555              DB        7        ;Invalid key - 37    
00CA 07                    556              DB        7        ;Invalid key - 38    
00CB 07                    557              DB        7        ;Invalid key - 39    
00CC 07                    558              DB        7        ;Invalid key - 40    
00CD 07                    559              DB        7        ;Invalid key - 41    
00CE 07                    560              DB        7        ;Invalid key - 42    
00CF 07                    561              DB        7        ;Invalid key - 43    
00D0 07                    562              DB        7        ;Invalid key - 44    
00D1 07                    563              DB        7        ;Invalid key - 45    
00D2 07                    564              DB        7        ;Invalid key - 46    
00D3 07                    565              DB        7        ;Invalid key - 47    
00D4 02                    566              DB        2        ;SW5 - 48    
00D5 07                    567              DB        7        ;Invalid key - 49    
00D6 07                    568              DB        7        ;Invalid key - 50    
00D7 07                    569              DB        7        ;Invalid key - 51    
00D8 07                    570              DB        7        ;Invalid key - 52    
00D9 07                    571              DB        7        ;Invalid key - 53    
00DA 07                    572              DB        7        ;Invalid key - 54    
00DB 07                    573              DB        7        ;Invalid key - 55    
00DC 03                    574              DB        3        ;SW6 - 56    
00DD 07                    575              DB        7        ;Invalid key - 57    
00DE 07                    576              DB        7        ;Invalid key - 58    
00DF 07                    577              DB        7        ;Invalid key - 59    
00E0 04                    578              DB        4        ;SW7 - 60    
00E1 07                    579              DB        7        ;Invalid key - 61
00E2 05                    580              DB        5        ;SW8 - 62    
00E3 06                    581              DB        6        ;SW9 - 63    
                           582         
                           583          
                           584     
                           585     
                           586     
----                       587     CODE ENDS
                           588     
                           589     ;start data segment
                           590     
----                       591     DATA    SEGMENT PUBLIC  'DATA'
                           592     
0000 ????                  593     DebounceCnt        DW    ?     ;how many more irq before calling Enqueue
0002 ??                    594     LastRead           DB    ?     ;value of last key read after masking
0003 ??                    595     ButtonQueue    QueueStruct<>   ;allocate the button queue
0004 ????
0006 ????
0008 ????
000A (256
     ??
8086/87/88/186 MACRO ASSEMBLER    BUTTON                                                   18:31:39  05/30/;6  PAGE   12


LOC  OBJ                  LINE     SOURCE

     )
                           596     
                           597     
----                       598     DATA ENDS
                           599     
                           600     
                           601     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
