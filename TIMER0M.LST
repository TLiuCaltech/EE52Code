8086/87/88/186 MACRO ASSEMBLER    TIMER0M                                                  14:05:58  05/14/;6  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER0M
OBJECT MODULE PLACED IN TIMER0M.OBJ
ASSEMBLER INVOKED BY:  C:\WINDOWS\SYSTEM32\ASM86.EXE TIMER0M.ASM M1 EP DB


LOC  OBJ                  LINE     SOURCE

                             1         NAME  TIMER0M
                             2     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             3     ;                                                                            ;
                             4     ;                                    TIMER0M                                 ;
                             5     ;                              Timer0 - MP3 Functions                        ;
                             6     ;                                   EE/CS 51                                 ;
                             7     ;                                                                            ;
                             8     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             9     
                            10     
                            11     ; Description:  This file contains the functions for initializing the chip 
                            12     ;               select, clearing the interrupt vector table, installing the
                            13     ;               event handler, and initializing the timer.
                            14     
                            15     ; Table of Contents
                            16     ;
                            17     ;   
                            18     ;   InitTimer0              -start the timer
                            19     ;   ButtonEH                -event handler for buttons
                            20     
                            21     ; Revision History::
                            22     ;       10/27/15    Tim Liu     initial revision
                            23     ;       10/28/15    Tim Liu     initdisplay initializes DS
                            24     ;       10/29/15    Tim Liu     added timer event handler
                            25     ;       11/3/15     Tim Liu     TimerEventHandler also handles key presses
                            26     ;       11/5/15     Tim Liu     Changed name of TimerEventHandler to
                            27     ;                               MuxKeypadEventHandler
                            28     ;       12/1/15     Tim Liu     Changed all Timer to Timer0
                            29     ;       12/1/15     Tim Liu     Added IRQ.INC file
                            30     ;       4/5/16      Tim Liu     Changed name to Timer0M for MP3 player
                            31     ;       4/21/16     Tim Liu     Changed MuxKeypandEventHandler to ButtonEH
                            32     ;       5/5/16      Tim Liu     Added call to UpdateClock to ButtonEH
                            33     
                            34     
                            35     ; local include files
                            36     
                            37 +1  $INCLUDE(TIMER0M.INC)
                      =1    38     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    39     ;                                                                            ;
                      =1    40     ;                                  Timer0M.INC                               ;
                      =1    41     ;                           Timer0 - MP3 includefile                         ;
                      =1    42     ;                                   EE/CS 52                                 ;
                      =1    43     ;                                                                            ;
                      =1    44     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    45     
                      =1    46     ; This file contains the definitions for timer.asm.
                      =1    47     ;
                      =1    48     ; Revision History:
                      =1    49     ;    11/4/15     Timothy Liu     initial revision
                      =1    50     ;    04/4/16     Timothy Liu     changed name to Timer0M.INC for MP3 player
8086/87/88/186 MACRO ASSEMBLER    TIMER0M                                                  14:05:58  05/14/;6  PAGE    2


LOC  OBJ                  LINE     SOURCE

                      =1    51     ;    04/4/16     Timothy Liu     changed COUNTS_PER_MS to 20 mHZ clock value
                      =1    52     ;    05/6/16     Timothy Liu     corrected COUNTS_PER_MS value for 24 mHz
                      =1    53     
                      =1    54     
                      =1    55     
                      =1    56     ; Addresses
  FF56                =1    57     Tmr0Ctrl        EQU     0FF56H          ;address of Timer 0 Control Register
  FF52                =1    58     Tmr0MaxCntA     EQU     0FF52H          ;address of Timer 0 Max Count A Register
  FF50                =1    59     Tmr0Count       EQU     0FF50H          ;address of Timer 0 Count Register
                      =1    60     
                      =1    61     ; Control Register Values
  E001                =1    62     Tmr0CtrlVal     EQU     1110000000000001B ;Timer 0 Control Register value
                      =1    63                            ;1---------------  enable timer
                      =1    64                            ;-1--------------  write to control
                      =1    65                            ;--1-------------  enable interrupts
                      =1    66                            ;---0000000-0000-  reserved
                      =1    67                            ;----------0-----  read only
                      =1    68                            ;---------------1  continuous mode
                      =1    69     ; Timing Definitions
                      =1    70     
  0BB8                =1    71     COUNTS_PER_MS   EQU     3000            ;number of timer counts per 1 ms
                      =1    72                                             ;(assumes 24 MHz external clock)
                      =1    73     
                      =1    74     
                      =1    75     
                            76 +1  $INCLUDE(MIRQ.INC)
                      =1    77     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    78     ;                                                                            ;
                      =1    79     ;                                   MIRQ.INC                                 ;
                      =1    80     ;                          MP3 Interrupt Include File                        ;
                      =1    81     ;                                   EE/CS 52                                 ;
                      =1    82     ;                                                                            ;
                      =1    83     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    84     
                      =1    85     ; This file contains the definitions for initcs.asm.
                      =1    86     ;
                      =1    87     ; Revision History:
                      =1    88     ;    4/4/16     Timothy Liu     created file and wrote definitions w/o values
                      =1    89     
                      =1    90     
                      =1    91     ;Interrupt Vector Table
  0001                =1    92     FIRST_RESERVED_VEC           EQU        1       ;reserve vectors 1-3
  0003                =1    93     LAST_RESERVED_VEC            EQU          3
  0100                =1    94     NUM_IRQ_VECTORS              EQU      256  ;number of interrupt vectors
  0004                =1    95     INTERRUPT_SIZE               EQU        4  ;each vector is 4 addresses large
                      =1    96     
                      =1    97     ;Addresses
  FF22                =1    98     INTCtrlrEOI     EQU     0FF22H          ;address of interrupt controller EOI register
  FF32                =1    99     INTCtrlrCtrl    EQU     0FF32H          ;address of interrupt controller for timer
                      =1   100     
                      =1   101     ;ICON0Address                            ;address of ICON0 register
                      =1   102     ;ICON1Address                            ;address of ICON1 register
                      =1   103     
                      =1   104     ; Register Values
  0001                =1   105     INTCtrlrCVal    EQU     00001H          ;set priority for timers to 1 and enable
8086/87/88/186 MACRO ASSEMBLER    TIMER0M                                                  14:05:58  05/14/;6  PAGE    3


LOC  OBJ                  LINE     SOURCE

                      =1   106                                             ;000000000000----  reserved
                      =1   107                                             ;------------0---  enable timer interrupt
                      =1   108                                             ;-------------001  timer priority
                      =1   109     
                      =1   110     
                      =1   111     ; End of Interrupt values
  8000                =1   112     NonSpecEOI      EQU     08000H          ;Non-specific EOI command
  0008                =1   113     TimerEOI        EQU     00008H          ;Timer EOI command (same for all timers)
                      =1   114     ;INT0EOI
                      =1   115     ;INT1EOI
                      =1   116     
                      =1   117     ; Interrupt Vector
  0008                =1   118     Tmr0Vec         EQU     8               ;interrupt vector for Timer 0
  0012                =1   119     Tmr1Vec         EQU     18              ;interrupt vector for Timer 1
                      =1   120     ;INT0Vec
                      =1   121     ;INT1VEc
                           122 +1  $INCLUDE(GENERAL.INC)
                      =1   123     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1   124     ;                                                                            ;
                      =1   125     ;                                  General.INC                               ;
                      =1   126     ;                               General include file                         ;
                      =1   127     ;                                   EE/CS 51                                 ;
                      =1   128     ;                                                                            ;
                      =1   129     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1   130     
                      =1   131     ; This file contains general definitions and constants.
                      =1   132     ;
                      =1   133     ; Revision History:
                      =1   134     ;    11/3/15     Timothy Liu     initial revision
                      =1   135     ;    11/5/15     Timothy Liu     fixed formatting
                      =1   136     ;    11/5/15     Timothy Liu     update for HW6 - added timer1vec
                      =1   137     ;    11/17/15    Timothy Liu     update for HW7 - added Serial_Vector and INT2EOI
                      =1   138     ;    11/19/15    Timothy Liu     removed interrupt related definitions
                      =1   139     ;    12/5/15     Timothy Liu     added ASCII definitions
                      =1   140     
                      =1   141     
                      =1   142     
  0004                =1   143     BitsPerNibble        EQU        4         ;number of bits in a nibble
                      =1   144     
  0002                =1   145     OffSize              EQU        2         ;offset size in bytes
                      =1   146     
                      =1   147     ;Ascii definitions
  000D                =1   148     ASCII_CR             EQU       13         ;ASCII carriage return
  0044                =1   149     ASCII_D              EQU       68         ;ASCII code for D
  0045                =1   150     ASCII_E              EQU       69         ;ASCII E
  0046                =1   151     ASCII_F              EQU       70         ;F character for fire (laser on)
  0049                =1   152     ASCII_I              EQU       73         ;I character
  004C                =1   153     ASCII_L              EQU       76         ;L character
  004F                =1   154     ASCII_O              EQU       79         ;O character for off (laser off)
  0050                =1   155     ASCII_P              EQU       80         ;P character
  0052                =1   156     ASCII_R              EQU       82         ;R character
  0053                =1   157     ASCII_S              EQU       83         ;S character
  0054                =1   158     ASCII_T              EQU       84         ;T character
  0000                =1   159     ASCII_NULL           EQU        0         ;ASCII null character
  0020                =1   160     ASCII_SPACE          EQU       32         ;ASCII space
8086/87/88/186 MACRO ASSEMBLER    TIMER0M                                                  14:05:58  05/14/;6  PAGE    4


LOC  OBJ                  LINE     SOURCE

  003A                =1   161     ASCII_COLON          EQU       58         ;ASCII colon
  003E                =1   162     ASCII_RArrow         EQU       62         ;ASCII > symbol
                      =1   163     
  0001                =1   164     TRUE                 EQU        1         ;true
  0000                =1   165     FALSE                EQU        0         ;false
                      =1   166     
  0002                =1   167     WORD_SIZE            EQU        2         ;2 bytes per word
                           168     
                           169     
                           170     CGROUP    GROUP    CODE
                           171     
                           172     
                           173     
----                       174     CODE SEGMENT PUBLIC 'CODE'
                           175     
                           176             ASSUME  CS:CGROUP
                           177     
                           178     ; external function declarations
                           179     
                           180             EXTRN       ButtonDebounce:NEAR      ;scan and check keypad
                           181             EXTRN       UpdateClock:NEAR         ;update clock tracking milliseconds
                           182     
                           183     
                           184     ; InitTimer0
                           185     ;
                           186     ; Description:       Initialize the 80188 timer0.  The timer is initialized
                           187     ;                    to generate interrupts every COUNTS_PER_MS clock cycles.
                           188     ;                    The interrupt controller is also initialized to allow the
                           189     ;                    timer interrupts. Timer #0 counts COUNTS_PER_MS.
                           190     ;
                           191     ; Operation:         Timer0 is first reset. The appropriate values are written
                           192     ;                    to the timer control registers in the PCB. Finally, the
                           193     ;                    interrupt controller is setup to accept timer interrupts
                           194     ;                    and any pending interrupts are cleared by sending 
                           195     ;                    a TimerEOI to the interrupt controller.
                           196     ;                    
                           197     ;
                           198     ; Arguments:         None.
                           199     ; Return Value:      None.
                           200     ;
                           201     ; Local Variables:   None.
                           202     ; Shared Variables:  None.
                           203     ; Global Variables:  None.
                           204     ;
                           205     ; Input:             None.
                           206     ; Output:            None.
                           207     ;
                           208     ; Error Handling:    None.
                           209     ;
                           210     ; Algorithms:        None.
                           211     ; Data Structures:   None.
                           212     ;
                           213     ; Registers Changed: AX, DX
                           214     ; Stack Depth:       0 words
                           215     ;
8086/87/88/186 MACRO ASSEMBLER    TIMER0M                                                  14:05:58  05/14/;6  PAGE    5


LOC  OBJ                  LINE     SOURCE

                           216     ; Author:            Timothy Liu
                           217     ; Last Modified:     10/27/15
                           218     
0000                       219     InitTimer0      PROC    NEAR
                           220                     PUBLIC  InitTimer0
                           221     
                           222     
0000 BA50FF                223             MOV     DX, Tmr0Count   ;initialize the count register to 0
0003 33C0                  224             XOR     AX, AX
0005 EE                    225             OUT     DX, AL
                           226     
0006 BA52FF                227             MOV     DX, Tmr0MaxCntA  ;setup max count for 1ms counts
0009 B8B80B                228             MOV     AX, COUNTS_PER_MS
000C EE                    229             OUT     DX, AL
                           230     
000D BA56FF                231             MOV     DX, Tmr0Ctrl    ;setup the control register
0010 B801E0                232             MOV     AX, Tmr0CtrlVal
0013 EE                    233             OUT     DX, AL
                           234     
                           235     
                           236                                     ;initialize interrupt controller for timers
0014 BA32FF                237             MOV     DX, INTCtrlrCtrl;setup the interrupt control register
0017 B80100                238             MOV     AX, INTCtrlrCVal
001A EE                    239             OUT     DX, AL
                           240     
001B BA22FF                241             MOV     DX, INTCtrlrEOI ;send a timer EOI (to clear out int. controller)
001E B80800                242             MOV     AX, TimerEOI
0021 EE                    243             OUT     DX, AL
                           244     
                           245     
0022 C3                    246             RET                     ;done so return
                           247     
                           248     
                           249     InitTimer0       ENDP
                           250     
                           251     
                           252     
                           253     ; ButtonEH
                           254     ;
                           255     ; Description:       This procedure is the event handler for the timer0
                           256     ;                    interrupt. This function saves the registers and
                           257     ;                    calls ButtonDebounce. Every call to ButtonDebounce
                           258     ;                    scans the buttons and checks for a button press.
                           259     ;                    The procedure also calls UpdateClock, which updates
                           260     ;                    the number of milliseconds that have elapsed.
                           261     ;                    The function then pops the stack
                           262     ;                    and sends an EOI.
                           263     ;
                           264     ; Operation:         Save all the registers and call ButtonDebounce to scan 
                           265     ;                    the 8 UI buttons for key presses. Call UpdateClock
                           266     ;                    to increment the MP3 timer Send an EOI at the end.
                           267     ;                    
                           268     ; Arguments:         None.
                           269     ; Return Value:      None.
                           270     ;
8086/87/88/186 MACRO ASSEMBLER    TIMER0M                                                  14:05:58  05/14/;6  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           271     ; Local Variables:   None
                           272     ; Shared Variables:  None.
                           273     ;
                           274     ; Input:             None.
                           275     ; Output:            None
                           276     ;
                           277     ; Error Handling:    None.
                           278     ;
                           279     ; Algorithms:        None.
                           280     ; Data Structures:   None.
                           281     ;
                           282     ; Registers Changed: None
                           283     ;
                           284     ; Author:            Timothy Liu
                           285     ; Last Modified:     5/5/16
                           286     
0023                       287     ButtonEH                    PROC    NEAR
                           288                                 PUBLIC  ButtonEH
                           289     
0023 50                    290             PUSH    AX                      ;save the registers
0024 53                    291             PUSH    BX                      ;
0025 52                    292             PUSH    DX                      ;
0026 E80000         E      293             Call    ButtonDebounce          ;check the keypad
0029 E80000         E      294             CALL    UpdateClock             ;increment milliseconds elapsed
                           295     
                           296     
002C                       297     EndButtonEH:                            ;done taking care of the timer
                           298     
002C BA22FF                299             MOV     DX, INTCtrlrEOI         ;send Timer EOI to the INT controller
002F B80800                300             MOV     AX, TimerEOI
0032 EE                    301             OUT     DX, AL
                           302     
0033 5A                    303             POP     DX                      ;restore the registers
0034 5B                    304             POP     BX
0035 58                    305             POP     AX
                           306     
                           307     
0036 CF                    308             IRET                            ;and return
                           309     
                           310     
                           311     
                           312     
                           313     ButtonEH       ENDP
                           314     
                           315     
----                       316     CODE ENDS
                           317     
                           318     
                           319             END

ASSEMBLY COMPLETE, NO ERRORS FOUND
