8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE IDE
OBJECT MODULE PLACED IN IDE.OBJ
ASSEMBLER INVOKED BY:  C:\WINDOWS\SYSTEM32\ASM86.EXE IDE.ASM M1 EP DB


LOC  OBJ                  LINE     SOURCE

                             1         NAME    IDE
                             2     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             3     ;                                                                            ;
                             4     ;                                   IDE Code                                 ;
                             5     ;                             IDE Related Functions                          ;
                             6     ;                                   EE/CS 52                                 ;
                             7     ;                                                                            ;
                             8     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             9     
                            10     ; Description: This file contains the functions relating to the IDE software.
                            11     
                            12     
                            13     ; Table of Contents:
                            14     ;
                            15     ;    Add32Bit          - adds value to 32 bit value
                            16     ;    CalculatePhysical - calculates physical address from segment/offset
                            17     ;    CheckIDEBusy      - checks if the IDE is busy
                            18     ;    Get_Blocks        - retrieves number of blocks from IDE
                            19     
                            20     ; Revision History:
                            21     ;    5/8/16    Tim Liu    Created file
                            22     ;    5/9/16    Tim Liu    Created skeleton of Get_blocks
                            23     ;    5/12/16   Tim Liu    Outlined Get_blocks
                            24     ;    5/13/16   Tim Liu    Wrote Add32Bit
                            25     ;    5/13/16   Tim Liu    Wrote outline for CalculatePhysical
                            26     
                            27     
                            28     ; local include files
                            29 +1  $INCLUDE(IDE.INC)
                      =1    30     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    31     ;                                                                            ;
                      =1    32     ;                                    IDE.inc                                 ;
                      =1    33     ;                                IDE Include File                            ;
                      =1    34     ;                                   EE/CS 52                                 ;
                      =1    35     ;                                                                            ;
                      =1    36     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    37     
                      =1    38     ; This file contains the definitions for the IDE.
                      =1    39     ;
                      =1    40     ; Revision History:
                      =1    41     ;    5/9/16    Tim Liu    created file
                      =1    42     
  8000                =1    43     IDEStatusSeg    EQU     8000h       ;segment of the IDE status register
  0E00                =1    44     IDEStatusOffset EQU     0E00h       ;offset of the IDE status register
  00C8                =1    45     IDEStatusMask   EQU     11001000b   ;mask everything but the busy, device
                      =1    46                                         ;ready, and data request flags
  0048                =1    47     IDEReady        EQU     01001000b   ;01001000b
                      =1    48                                         ;0-------   not busy
                      =1    49                                         ;-1------   device ready
                      =1    50                                         ;----1---   data request ready
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    2


LOC  OBJ                  LINE     SOURCE

                      =1    51     ; DMA control register addresses
  FFC0                =1    52     D0SRCL          EQU     0FFC0H      ;address of source address pointer low
  FFC2                =1    53     D0SRCH          EQU     0FFC2H      ;address of source address pointer high
  FFC4                =1    54     D0DSTL          EQU     0FFC4H      ;address of dest. address pointer low
  FFC6                =1    55     D0DSTH          EQU     0FFC6H      ;address of dest. address pointer high
  FFC8                =1    56     D0TC            EQU     0FFC8H      ;address of DMA transfer count register
  FFCA                =1    57     D0Con           EQU     0FFCAH      ;address of DMA control register
                      =1    58     
                      =1    59     ; DMA values
  0004                =1    60     DxConVal1       EQU     00004H      ; value to allow changing start bit
                      =1    61                                         ;0000000000000-00b unimportant
                      =1    62                                         ;0000000000000100b set change start bit
  B426                =1    63     DxConVal2       EQU     0B426H      ; value to write to DxCON to initiate DMA
                      =1    64                                         ;1011010000100110b
                      =1    65                                         ;1---------------  destination in memory
                      =1    66                                         ;-0--------------  donb^^t decrement dest.
                      =1    67                                         ;--1-------------  increment dest. pointer
                      =1    68                                         ;---1------------  source in memory space
                      =1    69                                         ;----0-----------  donb^^t decrement source
                      =1    70                                         ;-----1----------  increment source ptr.
                      =1    71                                         ;------0---------  terminal count - ignored
                      =1    72                                         ;-------0--------  no interrupt request
                      =1    73                                         ;--------00------  unsynchronized transfer
                      =1    74                                         ;----------1-----  high priority
                      =1    75                                         ;-----------0----  external DMA
                      =1    76                                         ;------------0---  reserved
                      =1    77                                         ;-------------1--  enable changing start bit
                      =1    78                                         ;--------------1-  arm DMA channel
                      =1    79                                         ;---------------0  perform byte transfers
  000C                =1    80     DxSRCHVal       EQU     0CH         ;bits 16:19 of DMA source
  0000                =1    81     DxSRCLVal       EQU     0H          ;bits 0:15 DMA source
                      =1    82                                         ;AB9-11 must be zero for data register
  0200                =1    83     D0TCval         EQU     512         ;number of transfers performed by DMA
                      =1    84     
                            85 +1  $INCLUDE(GENERAL.INC)
                      =1    86     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    87     ;                                                                            ;
                      =1    88     ;                                  General.INC                               ;
                      =1    89     ;                               General include file                         ;
                      =1    90     ;                                   EE/CS 51                                 ;
                      =1    91     ;                                                                            ;
                      =1    92     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    93     
                      =1    94     ; This file contains general definitions and constants.
                      =1    95     ;
                      =1    96     ; Revision History:
                      =1    97     ;    11/3/15     Timothy Liu     initial revision
                      =1    98     ;    11/5/15     Timothy Liu     fixed formatting
                      =1    99     ;    11/5/15     Timothy Liu     update for HW6 - added timer1vec
                      =1   100     ;    11/17/15    Timothy Liu     update for HW7 - added Serial_Vector and INT2EOI
                      =1   101     ;    11/19/15    Timothy Liu     removed interrupt related definitions
                      =1   102     ;    12/5/15     Timothy Liu     added ASCII definitions
                      =1   103     
                      =1   104     
                      =1   105     
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    3


LOC  OBJ                  LINE     SOURCE

  0004                =1   106     BitsPerNibble        EQU        4         ;number of bits in a nibble
                      =1   107     
  0002                =1   108     OffSize              EQU        2         ;offset size in bytes
                      =1   109     
                      =1   110     ;Ascii definitions
  000D                =1   111     ASCII_CR             EQU       13         ;ASCII carriage return
  0044                =1   112     ASCII_D              EQU       68         ;ASCII code for D
  0045                =1   113     ASCII_E              EQU       69         ;ASCII E
  0046                =1   114     ASCII_F              EQU       70         ;F character for fire (laser on)
  0049                =1   115     ASCII_I              EQU       73         ;I character
  004C                =1   116     ASCII_L              EQU       76         ;L character
  004F                =1   117     ASCII_O              EQU       79         ;O character for off (laser off)
  0050                =1   118     ASCII_P              EQU       80         ;P character
  0052                =1   119     ASCII_R              EQU       82         ;R character
  0053                =1   120     ASCII_S              EQU       83         ;S character
  0054                =1   121     ASCII_T              EQU       84         ;T character
  0000                =1   122     ASCII_NULL           EQU        0         ;ASCII null character
  0020                =1   123     ASCII_SPACE          EQU       32         ;ASCII space
  003A                =1   124     ASCII_COLON          EQU       58         ;ASCII colon
  003E                =1   125     ASCII_RArrow         EQU       62         ;ASCII > symbol
                      =1   126     
  0001                =1   127     TRUE                 EQU        1         ;true
  0000                =1   128     FALSE                EQU        0         ;false
                      =1   129     
  0002                =1   130     WORD_SIZE            EQU        2         ;2 bytes per word
                           131     
                           132     CGROUP    GROUP    CODE
                           133     
                           134     
----                       135     CODE SEGMENT PUBLIC 'CODE'
                           136     
                           137             ASSUME  CS:CGROUP 
                           138     
                           139     ;external function declarations
                           140     
                           141     ;Name:               Add32Bit
                           142     ;
                           143     ;Description:        This function adds a value to a 32 bit unsigned value in
                           144     ;                    memory. The function is passed two arguments - the 
                           145     ;                    value to add in AX and the address of the 32 bit value
                           146     ;                    in ES:SI. 
                           147     ; 
                           148     ;Operation:          The function adds AX to the low word pointed to by
                           149     ;                    ES:SI. The function then adds with carry 0 to the
                           150     ;                    high word pointed to by ES:SI+1 to add the carry
                           151     ;                    flag.
                           152     ;
                           153     ;Arguments:          AX - value to add
                           154     ;                    ES:SI - address of 32 bit value
                           155     ;
                           156     ;Return Values:      None
                           157     ;
                           158     ;Local Variables:    None
                           159     ;
                           160     ;Shared Variables:   None
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           161     ;
                           162     ;Output:             None
                           163     ;
                           164     ;Error Handling:     None
                           165     ;
                           166     ;Algorithms:         None
                           167     ;
                           168     ;Registers Used:     SI, flags register
                           169     ;
                           170     ;Known Bugs:         None
                           171     ;
                           172     ;Limitations:        None
                           173     ;
                           174     ;Author:             Timothy Liu
                           175     ;
                           176     ;Last Modified       5/13/16
                           177     
0000                       178     Add32Bit        PROC    NEAR
                           179                     PUBLIC  Add32Bit
                           180     
0000                       181     Add32BitStart:                           ;starting label
0000 260104                182         ADD    ES:[SI], AX                   ;add value to low word
0003 2683540200            183         ADC    WORD PTR ES:[SI+2], 0         ;add the carry flag
                           184     
0008                       185     Add32BitEnd:
0008 C3                    186         RET                                  ;function done
                           187     
                           188     
                           189     ADD32Bit    ENDP
                           190     
                           191     ;Name:               CalculatePhysical
                           192     ;
                           193     ;Description:        This function calculates the physical address from
                           194     ;                    the segment and the offset. The segment and offset
                           195     ;                    are passed to the function through ES:SI. The
                           196     ;                    function writes the 20 bit physical address to
                           197     ;                    BX and CX with the low 16 bits in BX and the high
                           198     ;                    nibble in CX.
                           199     ; 
                           200     ;Operation:          The function copies the segment in ES:[SI+1] to CX.
                           201     ;                    The function then shifts CX so that the high order
                           202     ;                    nibble is in the lowest nibble and the three highest
                           203     ;                    nibbles are clear. The function then shifts the
                           204     ;                    high order word in ES:[SI] to the left to multiply
                           205     ;                    it by 16. The function places the lower order word
                           206     ;                    ES:[SI] in BX and adds the high order word ES:[SI+1]
                           207     ;                    to the low order word in BX. Finally, the function
                           208     ;                    adds with carry 0 to CX to carry the highest order
                           209     ;                    nibble. The function then returns with the low nibble
                           210     ;                    in BX and the high nibble in CX.
                           211     ;
                           212     ;Arguments:          ES:SI - 32 bit segment and offset
                           213     ;
                           214     ;Return Values:      BX - low 16 bits of physical address
                           215     ;                    CX - high 4 bits of physical address
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    5


LOC  OBJ                  LINE     SOURCE

                           216     ;
                           217     ;Local Variables:    None
                           218     ;
                           219     ;Shared Variables:   None
                           220     ;
                           221     ;Output:             None
                           222     ;
                           223     ;Error Handling:     None
                           224     ;
                           225     ;Algorithms:         None
                           226     ;
                           227     ;Registers Used:     BX, CX
                           228     ;
                           229     ;Known Bugs:         None
                           230     ;
                           231     ;Limitations:        None
                           232     ;
                           233     ;Author:             Timothy Liu
                           234     ;
                           235     ;Last Modified       5/13/16
                           236     
0009                       237     CalculatePhysical        PROC    NEAR
                           238     
0009                       239     CalculatePhysicalStart:                  ;starting label
0009 50                    240         PUSH    AX                           ;register
000A 52                    241         PUSH    DX                           ;save register
                           242     
000B                       243     CalculatePhysicalCopy:                   ;copy seg/offset to register
000B 268B1C                244         MOV     BX, ES:[SI]                  ;copy offset to register
000E 268B4C02              245         MOV     CX, ES:[SI+2]                ;copy segment to register
0012 268B5402              246         MOV     DX, ES:[SI+2]                ;second copy of segment
                           247     
0016                       248     CalculatePhysicalShift:                  ;shift registers to prepare for add
0016 C1E90C                249         SHR     CX, 3*BitsPerNibble          ;high order of seg in lowest nibble
0019 C1E204                250         SHL     DX, BitsPerNibble            ;shift copy of segment by one
                           251                                              ;nibble to prepare for add
                           252     
001C                       253     CalculatePhysicalAdd:                    ;calculate the 20 bit address
001C 03DA                  254         ADD    BX, DX                        ;calculate low 16 bits of address
001E 83D100                255         ADC    CX, 0                         ;add carry bit to highest nibble
                           256     
0021                       257     CalculatePhysicalDone:                   ;end of function
0021 5A                    258        POP     DX                            ;restore registers
0022 58                    259        POP     AX
0023 C3                    260        RET
                           261     
                           262     CalculatePhysical    ENDP
                           263     
                           264     
                           265     
                           266     
                           267     ;Name:               CheckIDEBusy
                           268     ;
                           269     ;Description:        This function checks the IDE to see if it is busy.
                           270     ;                    The function loops repeatedly checking the IDE until
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           271     ;                    it is no longer busy. The function does not return
                           272     ;                    until the IDE is ready. 
                           273     ; 
                           274     ;Operation:          The function loads the segment of the IDE status register
                           275     ;                    into ES and the offset into SI. The function then
                           276     ;                    reads the IDE status register and compares the value
                           277     ;                    to IDEReady. If the value is the same, then the
                           278     ;                    function returns and restores the registers. If the
                           279     ;                    IDE status register is not ready, then the function
                           280     ;                    loops repeatedly until the IDE is ready.
                           281     ;
                           282     ;Arguments:          None
                           283     ;
                           284     ;Return Values:      None
                           285     ;
                           286     ;Local Variables:    None
                           287     ;
                           288     ;Shared Variables:   None
                           289     ;
                           290     ;Output:             None
                           291     ;
                           292     ;Error Handling:     None
                           293     ;
                           294     ;Algorithms:         None
                           295     ;
                           296     ;Registers Used:     ES
                           297     ;
                           298     ;Known Bugs:         None
                           299     ;
                           300     ;Limitations:        None
                           301     ;
                           302     ;Author:             Timothy Liu
                           303     ;
                           304     ;Last Modified       5/13/16
                           305     
0024                       306     CheckIDEBusy    PROC    NEAR
                           307     
0024                       308     CheckIDEBusyStart:                      ;starting label
0024 56                    309         PUSH SI                             ;save registers
0025 50                    310         PUSH AX
                           311     
0026                       312     CheckIDEBusyAddress:                    ;set up address of status register
0026 B80080                313         MOV  AX, IDEStatusSeg
0029 8EC0                  314         MOV  ES, AX                         ;segment of the IDE Status register
002B BE000E                315         MOV  SI, IDEStatusOffset            ;offset of the IDE status register
                           316     
002E                       317     CheckIDEBusyLoop:                       ;loop reading the status register
002E 268A04                318         MOV  AL, ES:[SI]                    ;read the status register
0031 24C8                  319         AND  AL, IDEStatusMask              ;only interested in some bits
0033 3C48                  320         CMP  AL, IDEReady                   ;check if the register is ready
0035 7402                  321         JE   CheckIDEBusyDone               ;IDE ready - done
0037 EBF5                  322         JMP  CheckIDEBusyLoop               ;otherwise keep looping until ready
                           323     
0039                       324     CheckIDEBusyDone:
0039 58                    325         POP   AX
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    7


LOC  OBJ                  LINE     SOURCE

003A 5E                    326         POP   SI
003B C3                    327         RET
                           328     
                           329     
                           330     CheckIDEBusy    ENDP
                           331     
                           332     
                           333     ;Name:       Get_Blocks(unsigned long int, int, unsigned short int far *)
                           334     
                           335     ;
                           336     ;Description:        This function retrieves a number of blocks from the
                           337     ;                    IDE and transfers it to a specified address. The
                           338     ;                    function is passed three arguments - the address
                           339     ;                    of the blocks, the number of blocks, and the 
                           340     ;                    address to write to. The function reads from the 
                           341     ;                    IDE and performs a DMA transfer to the specified
                           342     ;                    location. The function returns the number of blocks
                           343     ;                    actually read.
                           344     ; 
                           345     ;Operation:          The function first uses BP to index into the stacks
                           346     ;                    and retrieve the arguments. The function loops through
                           347     ;                    the top of the stack and copies the arguments to the
                           348     ;                    array GetBlockArgs. The function then writes to the 
                           349     ;                    command block registers. The function writes the 
                           350     ;                    number of sectors to transfer, the LBA address, and 
                           351     ;                    specifies to use LBA addressing. The function looks
                           352     ;                    up the addresses to write the commands to
                           353     ;                    in IDEAddressTable. The function then loops checking 
                           354     ;                    the ready to transfer data flag of IDEStatusReg.
                           355     ;                    Once the flag is clear, the function writes to the
                           356     ;                    command register IDEDMA to initiate DMA. The
                           357     ;                    function writes the destination pointer address passed
                           358     ;                    as the third argument to DxDSTH and DxDSTL. The function
                           359     ;                    writes IDEStartAddress to DxSRCL. To initiate the
                           360     ;                    DMA, the procedure writes DxConVal to DxCon. The
                           361     ;                    function (???) somehow returns the number of blocks 
                           362     ;                    read in AX and restores the registers
                           363     ;                    
                           364     ;
                           365     ;Arguments:          StartBlock(unsigned long int) - starting logical block
                           366     ;                    to read from
                           367     ;
                           368     ;                    NumBlocks(int) - number of blocks to retrieve
                           369     ;
                           370     ;                    DestinationPointer(unsigned short in far *) -
                           371     ;                    address of destination
                           372     ;                      
                           373     ;
                           374     ;Return Values:      AX - number of blocks actually read
                           375     ;
                           376     ;Local Variables:    None
                           377     ;
                           378     ;Shared Variables:   None
                           379     ;
                           380     ;Output:             None
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    8


LOC  OBJ                  LINE     SOURCE

                           381     ;
                           382     ;Error Handling:     None
                           383     ;
                           384     ;Algorithms:         None
                           385     ;
                           386     ;Registers Used:     None
                           387     ;
                           388     ;Known Bugs:         None
                           389     ;
                           390     ;Limitations:        None
                           391     ;
                           392     ;Author:             Timothy Liu
                           393     ;
                           394     ;Last Modified       5/12/16
                           395     ;
                           396     ;Outline
                           397     ;Get_Blocks(StartBlock, NumBlocks, Destination)
                           398     ;    Save BP                           ;set up indexing into stack to pull arg
                           399     ;    BP = SP
                           400     ;    Save other registers
                           401     ;    While NumBlocks > 0                   ;loop writing each block
                           402     ;       Add32Bit(BP+4, BP+6)               ;function to recalculate the LBA
                           403     ;                                          ;after incrementing the sector
                           404     ;                                          ;add 256 to low and add carry bit
                           405     ;       Add32Bit(BP+10, BP+12)             ;recalculate destination pointer
                           406     ;
                           407     ;       CheckBusyFlag()                      ;write to LBA addresses
                           408     ;       LBA7:0 = BP + 4
                           409     ;       CheckBusyFlag()
                           410     ;       LBA15:8 = BP + 5
                           411     ;       CheckBusyFlag()
                           412     ;       LBA23:16 = BP + 6
                           413     ;
                           414     ;       AL = BP + 7                           ;access LBA 24:31
                           415     ;       AL = BitMask(AL)                      ;apply bit mask
                           416     ;       CheckBusyFlag()
                           417     ;       DeviceLBA = AL                        ;write to DeviceLBA register
                           418     ;
                           419     ;       CheckBusyFlag()                       ;
                           420     ;       Write READ SECTOR Command             ;execute DMA
                           421     ;
                           422     ;       CalculatePhysical()                   ;calculate the physical address
                           423     ;                                             ;from the segment and offset
                           424     ;       DxDSTH = CP1                          ;write the destination addresses
                           425     ;       DxDSTL = CP2
                           426     ;       DxSRCH = DxSRCHVal                    ;always the same value
                           427     ;       DxSRCL = DxSRCLVal                    ;start address of MCS2
                           428     ;       DxCON = DxCONVal                      ;write to DxCON and start DMA
                           429                
                           430         
                           431         
                           432     
003C                       433     Get_Blocks        PROC    NEAR
                           434                       PUBLIC  Get_Blocks
                           435     
8086/87/88/186 MACRO ASSEMBLER    IDE                                                      15:18:10  05/14/;6  PAGE    9


LOC  OBJ                  LINE     SOURCE

003C                       436     Get_BlocksStart:                               ;starting label
003C C3                    437         RET
                           438     
                           439     
                           440     Get_Blocks      ENDP
                           441     
                           442     
----                       443     CODE ENDS
                           444     
                           445             END

ASSEMBLY COMPLETE, NO ERRORS FOUND
